<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    REAL Beads integration (steveyegge/beads):
    - Canonical work item is a Beads issue.
    - Use bd status transitions: open -> in_progress -> closed (or blocked).
    - Record implementation details as comments, and file follow-ups as discovered-from issues.
  </critical>

  <critical>
    ATOMIC SPEC CONVENTION (v1):
    - Find the latest comment containing the marker header: \"BMAD STORY SPEC v1\".
    - Treat that comment as the authoritative ordered task checklist (do NOT rely on any story.md file).
    - When you complete a task (e.g. \"Task 2\"), do NOT edit old comments; append a new progress comment with evidence.
  </critical>

  <step n="1" goal="Select next ready story issue">
    <action>Ensure `bd` is installed and the repo is initialized (bd init).</action>
    <action>Find ready work: bd ready --json</action>
    <action>Select the highest-priority ready issue with label bmad-story (or ready-for-dev). Set {{issue_id}}.</action>
    <action>Load issue: bd show {{issue_id}} --json</action>
    <action>Load spec comments: bd comments {{issue_id}} --json (or without --json if unsupported) and select the latest \"BMAD STORY SPEC v1\" comment.</action>
    <action>Load {project_context} for coding standards if exists</action>
  </step>

  <step n="2" goal="Implement and test">
    <action>Mark in progress: bd update {{issue_id}} --status in_progress --json</action>
    <action>Implement according to the issue spec and acceptance criteria. Follow red-green-refactor.</action>
    <action>Run full test suite. Fix failures.</action>
    <action>Comment progress with concrete evidence using this template (append-only):</action>
    <action>
      bd comments add {{issue_id}} \"BMAD PROGRESS v1\\nTask: <Task N title>\\nStatus: completed\\nEvidence:\\n- Files: <paths>\\n- Tests: <commands + result>\\n- Notes: <decisions/gotchas>\"
    </action>
  </step>

  <step n="3" goal="Close or block">
    <check if="all acceptance criteria satisfied and tests passing">
      <action>bd close {{issue_id}} --reason "Done" --json</action>
      <action>bd label add {{issue_id}} done</action>
      <output>✅ Closed issue {{issue_id}}</output>
    </check>

    <check if="blocked">
      <action>bd update {{issue_id}} --status blocked --json</action>
      <action>bd comments add {{issue_id}} "BMAD BLOCKED v1\nReason: <reason>\nNext action: <what unblocks>"</action>
      <output>⛔ Issue {{issue_id}} marked blocked</output>
    </check>
  </step>
</workflow>
