<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    REAL Beads integration (steveyegge/beads):
    - Canonical work item is a Beads issue.
    - Use bd status transitions: open -> in_progress -> open/blocked.
    - IMPORTANT: Do NOT close for review. Keep issue OPEN with label needs-review until review passes.
    - Record implementation details as comments, and file follow-ups as discovered-from issues.
  </critical>

  <critical>
    ATOMIC SPEC CONVENTION (v1):
    - Find the latest comment containing the marker header: \"BMAD STORY SPEC v1\".
    - Treat that comment as the authoritative ordered task checklist (do NOT rely on any story.md file).
    - When you complete a task (e.g. \"Task 2\"), do NOT edit old comments; append a new progress comment with evidence.
  </critical>

  <step n="1" goal="Select next ready story issue">
    <action>Ensure `bd` is installed and the repo is initialized (bd init).</action>
    <action>Find ready work: bd ready --json</action>
    <action>Select the highest-priority ready issue that matches ONE of:
      - label bmad-story + label ready-for-dev
      - label bmad-story + label needs-fix
      - label bmad-followup (optional)
      Set {{issue_id}}.
    </action>
    <action>Load issue: bd show {{issue_id}} --json</action>
    <action>Load spec comments: bd comments {{issue_id}} --json (or without --json if unsupported) and select the latest \"BMAD STORY SPEC v1\" comment.</action>
    <action>Load {project_context} for coding standards if exists</action>
  </step>

  <step n="2" goal="Implement and test">
    <action>bd label add {{issue_id}} in-dev</action>
    <action>Mark in progress: bd update {{issue_id}} --status in_progress --json</action>
    <action>Implement according to the issue spec and acceptance criteria. Follow red-green-refactor.</action>
    <action>Run full test suite. Fix failures.</action>
    <action>Comment progress with concrete evidence using this template (append-only):</action>
    <action>
      bd comments add {{issue_id}} \"BMAD PROGRESS v1\\nTask: <Task N title>\\nStatus: completed\\nEvidence:\\n- Files: <paths>\\n- Tests: <commands + result>\\n- Notes: <decisions/gotchas>\"
    </action>
  </step>

  <step n="3" goal="Hand off to review (or block)">
    <check if="all acceptance criteria satisfied and tests passing">
      <action>bd label remove {{issue_id}} in-dev</action>
      <action>bd label remove {{issue_id}} ready-for-dev</action>
      <action>bd label remove {{issue_id}} needs-fix</action>
      <action>bd label add {{issue_id}} needs-review</action>
      <action>Mark ready for review: bd update {{issue_id}} --status open --json</action>
      <output>✅ Implementation complete; issue {{issue_id}} is OPEN and labeled needs-review</output>
    </check>

    <check if="blocked">
      <action>bd update {{issue_id}} --status blocked --json</action>
      <action>bd comments add {{issue_id}} "BMAD BLOCKED v1\nReason: <reason>\nNext action: <what unblocks>"</action>
      <output>⛔ Issue {{issue_id}} marked blocked</output>
    </check>
  </step>
</workflow>
