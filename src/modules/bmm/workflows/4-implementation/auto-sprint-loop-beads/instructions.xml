<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    Beads-first (REAL Beads: steveyegge/beads):

    - The canonical work system is Beads issues, not markdown story files.
    - Use the bd CLI only; never edit .beads/* files by hand.
    - Use bd dependencies (blocks, parent-child, discovered-from) and bd ready as the queue.

    Loop control via bd config:
    - bmad.loop.stop_mode = story | epic | project
    - bmad.loop.current_issue = <issue-id>

    Multi-agent integrity:
    - Prefer bd daemon / bd sync for consistency
    - Use bd validate / bd doctor when the DB looks suspicious
  </critical>

  <step n="0" goal="Ensure bd is initialized and set stop mode">
    <action>Ensure `bd` is installed and available on PATH; if not, HALT with installation instructions (see https://github.com/steveyegge/beads)</action>
    <action>Run: bd init (if .beads is not present)</action>
    <action>Run: bd doctor</action>

    <action>Read stop mode: bd config get bmad.loop.stop_mode</action>
    <check if="stop_mode missing">
      <output>Chọn chế độ dừng vòng lặp (lưu vào Beads để lần sau không hỏi):</output>
      <output>1) Dừng sau khi xong 1 issue (story)</output>
      <output>2) Dừng sau khi xong 1 epic</output>
      <output>3) Chạy đến khi xong cả project</output>
      <ask>Nhập 1 / 2 / 3:</ask>
      <check if="user chooses 1"><action>bd config set bmad.loop.stop_mode story</action></check>
      <check if="user chooses 2"><action>bd config set bmad.loop.stop_mode epic</action></check>
      <check if="user chooses 3"><action>bd config set bmad.loop.stop_mode project</action></check>
    </check>
  </step>

  <step n="1" goal="Find next ready work">
    <critical>No-ask on work selection; always pick the top ready item in priority order.</critical>
    <action>Run: bd ready --json</action>
    <action>Select the highest-priority ready issue (lowest priority number). If multiple, pick the first in returned order.</action>
    <check if="no ready issues">
      <output>No ready issues. Check blocked issues:</output>
      <action>Run: bd blocked --json</action>
      <output>If everything is blocked, fix blockers or create new work. Loop stops here.</output>
      <action>HALT</action>
    </check>

    <action>Set {{issue_id}} = selected issue id</action>
    <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
  </step>

  <step n="2" goal="Execute: implement the issue">
    <action>Run: bd show {{issue_id}} --json</action>
    <action>Run: bd dep tree {{issue_id}} (verify not blocked)</action>
    <action>Update status: bd update {{issue_id}} --status in_progress --json</action>

    <action>Implement the issue according to its description/acceptance criteria. Write tests. Run the full test suite.</action>

    <action>Add a progress comment summarizing what changed and tests run:
      - bd comments add {{issue_id}} "Implemented: ...; Tests: ...; Files: ..."
    </action>

    <action>Close issue if complete:
      - bd close {{issue_id}} --reason "Done" --json
    </action>

    <check if="cannot complete due to missing info or external dependency">
      <action>bd update {{issue_id}} --status blocked --json</action>
      <action>bd comments add {{issue_id}} "BLOCKED: <why>"</action>
    </check>
  </step>

  <step n="3" goal="Stop-mode gate">
    <action>Read stop_mode: bd config get bmad.loop.stop_mode</action>

    <check if="stop_mode == 'story'">
      <output>⏸️ Dừng theo chế độ story: {{issue_id}} đã xử lý. Chạy lại workflow để tiếp tục issue tiếp theo.</output>
      <action>HALT</action>
    </check>

    <check if="stop_mode == 'epic'">
      <action>Determine the epic for this issue (if any) using parent-child dependencies or bd epic status.</action>
      <action>Run: bd epic status</action>
      <action>If the epic containing {{issue_id}} is now complete (all children closed), then HALT.</action>
      <check if="epic is complete">
        <output>⏸️ Dừng theo chế độ epic: epic đã hoàn tất. Chạy lại workflow để tiếp tục epic tiếp theo.</output>
        <action>HALT</action>
      </check>
    </check>
  </step>

  <step n="4" goal="Checkpoint for context clearing">
    <critical>
      After this checkpoint, it's safe to dismiss/clear agent context.
      Re-running this same workflow should resume from Beads state (bd config keys).
    </critical>
    <action>bd comments add {{issue_id}} "Checkpoint saved. Safe to clear agent context."
    </action>
    <action>HALT</action>
  </step>
</workflow>
