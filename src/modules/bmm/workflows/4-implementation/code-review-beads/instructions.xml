<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    REAL Beads integration (steveyegge/beads):
    - Review targets a Beads issue and its spec (description + spec comments).
    - No interactive choices: always auto-fix HIGH+MEDIUM issues when possible.
    - If follow-ups remain, create discovered-from issues and link them.
  </critical>

  <step n="1" goal="Select issue to review">
    <action>Ensure `bd` is installed and initialized.</action>
    <action>Select a recently completed story issue to review:
      - Prefer: bd list --status closed --label bmad-story --json (pick the most recent)
      - Or: user provides issue_id
    </action>
    <action>Set {{issue_id}}</action>
    <action>Load issue: bd show {{issue_id}} --json</action>
    <action>Load spec comments: bd comments {{issue_id}}</action>
    <action>Discover actual changes with git: git status --porcelain; git diff --name-only; git diff --cached --name-only</action>
    <action>Load {project_context} if exists</action>
  </step>

  <step n="2" goal="Adversarial review + auto-fix">
    <action>Validate each Acceptance Criterion against actual implementation.</action>
    <action>Find 3-10 actionable issues minimum. Categorize HIGH/MEDIUM/LOW.</action>
    <action>Auto-fix all HIGH+MEDIUM issues now when feasible (code + tests).</action>

    <action>Record review results as a comment on the issue:
      - bd comments add {{issue_id}} "REVIEW (AI):\nHIGH: ...\nMEDIUM: ...\nLOW: ...\nFixed: ...\nRemaining: ..."
    </action>

    <check if="remaining HIGH/MEDIUM issues exist">
      <action>Create follow-up issues and link them discovered-from:
        - bd create "Follow-up: ..." -t task -p 2 --deps discovered-from:{{issue_id}} --json
      </action>
    </check>
  </step>

  <step n="3" goal="Finalize status">
    <check if="all HIGH/MEDIUM fixed and ACs satisfied">
      <action>Ensure issue is closed (bd close {{issue_id}} if needed)</action>
      <action>bd label add {{issue_id}} reviewed</action>
      <output>âœ… Review complete: {{issue_id}}</output>
    </check>

    <check if="follow-ups exist">
      <output>ðŸ”„ Follow-ups created and linked to {{issue_id}}. Continue with bd ready queue.</output>
    </check>
  </step>
</workflow>
