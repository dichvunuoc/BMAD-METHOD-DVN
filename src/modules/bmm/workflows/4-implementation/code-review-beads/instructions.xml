<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>
  <critical>
    Beads-first:
    - The story is stored in Beads (namespace "stories").
    - Review status is tracked in Beads sprint.development_status.
    - No user choice prompts: always auto-fix HIGH+MEDIUM issues.
  </critical>

  <step n="1" goal="Select reviewable story and load it from Beads">
    <action>Run: {beads.cli.init}</action>
    <action>Run: {beads.cli.land}</action>
    <action>Read sprint tracking: {beads.cli.get} sprint development_status</action>
    <action>Pick FIRST story_key with status == "review" OR "in-progress"</action>
    <action>Set {{story_key}}</action>
    <action>Read canonical story: {beads.cli.get} stories {{story_key}}</action>
    <action>Run `git status --porcelain` and `git diff --name-only` to discover changed files</action>
    <action>Load {project_context} for coding standards if exists</action>
  </step>

  <step n="2" goal="Adversarial review + auto-fix">
    <action>Validate each Acceptance Criterion against actual implementation</action>
    <action>Validate each [x] task actually done</action>
    <action>Find 3-10 actionable issues minimum</action>
    <action>Auto-fix ALL HIGH+MEDIUM issues now (apply changes + add tests as needed)</action>
    <action>Update story markdown:
      - Append review notes under "Senior Developer Review (AI)"
      - Update Change Log
      - Update File List
      - Set Status to "done" if all issues resolved and ACs implemented; else "in-progress"</action>
  </step>

  <step n="3" goal="Persist review results to Beads">
    <action>Run: {beads.cli.land}</action>
    <action>Write updated story markdown: bmad beads set stories {{story_key}} <updated_markdown></action>
    <action>Update sprint.development_status[{{story_key}}] to "done" or "in-progress" and write back</action>
    <action>Append journal: bmad beads append devlog {{story_key}} {"event":"review","ts":"{date}","status":"{{new_status}}"}</action>
    <action>Run: {beads.cli.land}</action>
    <output>✅ Code review complete (Beads-first): {{story_key}} → {{new_status}}</output>
  </step>
</workflow>
